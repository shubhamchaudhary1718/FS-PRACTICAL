<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chatter ‚Äî Minimal Social Chat</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1020; --panel:#121735; --muted:#93a5fd; --text:#e8eeff; --accent:#6c7cff; --accent-2:#16db65; --danger:#ff5c7a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(120deg,#0b1020,#141a3f);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .app{display:grid;grid-template-columns:280px 1fr;min-height:100vh}
    .sidebar{background:rgba(18,23,53,.7);backdrop-filter: blur(8px);border-right:1px solid rgba(255,255,255,.08);padding:16px;display:flex;flex-direction:column;gap:16px}
    .logo{display:flex;align-items:center;gap:10px;font-weight:700}
    .logo .dot{width:10px;height:10px;border-radius:50%;background:var(--accent-2);box-shadow:0 0 18px var(--accent-2)}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:16px}
    .user-card{display:flex;align-items:center;gap:10px;padding:12px}
    .user-card img{width:36px;height:36px;border-radius:50%}
    .btn, button, input, textarea{font-family:inherit}
    .btn{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.05);color:var(--text);cursor:pointer}
    .btn.primary{background:var(--accent);border-color:transparent}
    .btn.ghost{background:transparent;border-color:rgba(255,255,255,.1)}
    .btn.full{width:100%}
    .muted{color:#a8b0d6;font-size:.9rem}
    .search{display:flex;gap:8px;padding:10px}
    .search input{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.2);color:var(--text)}
    .nav{display:flex;flex-direction:column;gap:8px;padding:10px}
    .nav .item{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;cursor:pointer}
    .nav .item.active,.nav .item:hover{background:rgba(255,255,255,.08)}
    .chats{display:flex;flex-direction:column;gap:6px;padding:8px;overflow:auto}
    .chat-row{display:grid;grid-template-columns:46px 1fr auto;gap:10px;padding:10px;border-radius:12px;cursor:pointer}
    .chat-row:hover{background:rgba(255,255,255,.06)}
    .chat-row img{width:46px;height:46px;border-radius:50%}
    .chat-row .name{font-weight:600}
    .chat-row .last{color:#b7bde3;font-size:.92rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .main{display:flex;flex-direction:column;height:100vh}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid rgba(255,255,255,.08);background:rgba(18,23,53,.6);backdrop-filter: blur(8px)}
    .topbar .title{display:flex;align-items:center;gap:10px}
    .content{display:grid;grid-template-rows:1fr auto;gap:0;height:calc(100vh - 56px)}
    .messages{padding:14px;overflow:auto;display:flex;flex-direction:column;gap:8px}
    .bubble{max-width:70%;padding:10px 12px;border-radius:14px;line-height:1.35;color:var(--text)}
    .me{align-self:flex-end;background:linear-gradient(135deg,var(--accent),#8e99ff)}
    .you{align-self:flex-start;background:rgba(255,255,255,.08);color:var(--text)}
    .composer{display:grid;grid-template-columns:1fr auto;gap:10px;padding:12px;border-top:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.15)}
    .composer textarea{resize:none;height:50px;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.2);color:var(--text)}
    .auth{max-width:420px;margin:8vh auto;padding:20px;}
    .auth .group{display:flex;flex-direction:column;gap:6px;margin:8px 0}
    .auth input{padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.2);color:var(--text)}
    .switch{margin-top:6px;font-size:.95rem}
    .empty{display:grid;place-items:center;height:100%;color:#aeb7e9}
    .pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px dashed rgba(255,255,255,.18)}
    @media(max-width:980px){.app{grid-template-columns:1fr}.sidebar{position:fixed;z-index:10;inset:0 30% 0 0;transform:translateX(-100%);transition:.25s}.sidebar.open{transform:none} .topbar .menu{display:inline-block} .topbar .menu button{font-size:20px} .topbar .title{gap:8px} }
    @media(min-width:981px){.topbar .menu{display:none}}
    /* Reuse input styling for profile too */
.profile-card input {
  padding: 12px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.2);
  color: var(--text);
  font-size: 1rem;
  width: 100%;
}

  </style>
</head>
<body>
<!-- === AUTH VIEW === -->
<div id="authView" class="auth card" hidden>
  <div class="logo" style="margin-bottom:12px"><span class="dot"></span> <span>Chatter</span></div>
  <h2 id="authTitle">Create account</h2>
  <div class="group"><label>Name</label><input id="nameInput" placeholder="Ada Lovelace"/></div>
  <div class="group"><label>Email</label><input id="emailInput" type="email" placeholder="ada@chatter.app"/></div>
  <div class="group"><label>Password</label><input id="passwordInput" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/></div>
  <div class="group"><button class="btn primary full" id="authSubmit">Sign up</button></div>
  <div class="group"><button class="btn full" id="googleBtn">Continue with Google</button></div>
  <div class="switch" id="authSwitch">Already have an account? <a href="#" id="toLogin">Sign in</a></div>
  <p class="muted" style="margin-top:8px">Fill your Firebase config in the script to run locally.</p>
</div>

<!-- === APP VIEW === -->
<div id="appView" class="app" hidden>
  <aside class="sidebar" id="sidebar">
    <div class="logo"><span class="dot"></span><span>Chatter</span></div>
    <div class="card user-card">
      <img id="meAvatar" src="https://api.dicebear.com/9.x/thumbs/svg?seed=me" alt="me">
      <div>
        <div id="meName" style="font-weight:600">‚Äî</div>
        <div id="meEmail" class="muted">‚Äî</div>
      </div>
    </div>
    <div class="card search">
      <input id="userSearch" placeholder="Search users by name/email"/>
      <button class="btn" id="inviteBtn">+</button>
    </div>
    <div class="nav card">
      <div class="item active" id="navChats">üí¨ Chats</div>
      <div class="item" id="navPeople">üë• People</div>
      <div class="item" id="navProfile">üôç Profile</div>
      <div class="item" id="navLogout">üö™ Logout</div>
    </div>
    <div class="card" style="padding:8px;">
      <div class="muted" style="padding:8px 8px 0">Recent chats</div>
      <div class="chats" id="recentList"></div>
    </div>
    <div class="muted" style="padding:8px;text-align:center">Built with Firebase</div>
  </aside>
  <main class="main">
    <div class="topbar">
      <div class="title">
        <div class="menu"><button class="btn ghost" id="toggleSidebar">‚ò∞</button></div>
        <div><strong id="chatTitle">Welcome</strong><div id="chatSub" class="muted" style="font-size:.9rem">Select a conversation or find people to start chatting.</div></div>
      </div>
    </div>
    <div class="content">
      <div class="messages" id="messages"></div>
      <div class="composer" id="composer" hidden>
        <textarea id="messageInput" placeholder="Type a message‚Ä¶"></textarea>
        <button class="btn primary" id="sendBtn">Send</button>
      </div>
      <div class="empty" id="emptyState"><div class="pill">No chat selected</div></div>
    </div>
    <!-- === PEOPLE VIEW === -->
<div id="peopleView" hidden style="padding:20px;overflow:auto">
  <h2>People</h2>
  <div id="peopleList" style="display:flex;flex-direction:column;gap:12px;margin-top:12px"></div>
</div>

<!-- === PROFILE VIEW === -->
<div id="profileView" hidden style="padding:20px;overflow:auto">
  <h2 style="margin-bottom:16px">Profile</h2>
  <div class="card profile-card" style="padding:20px;max-width:420px;margin:auto;display:flex;flex-direction:column;gap:16px">
    
    <!-- Avatar + Basic Info -->
    <div style="display:flex;align-items:center;gap:16px">
      <img id="profileAvatar" src="" alt="me"
           style="width:70px;height:70px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,.12)">
      <div>
        <div id="profileName" style="font-weight:600;font-size:1.2rem"></div>
        <div id="profileEmail" class="muted" style="font-size:.95rem"></div>
      </div>
    </div>

    <!-- Editable Fields -->
    <div class="group">
      <label style="font-size:.9rem;color:#a8b0d6">Display name</label>
      <input id="profileNameInput" placeholder="Your name"/>
    </div>

    <div class="group">
      <label style="font-size:.9rem;color:#a8b0d6">Avatar URL</label>
      <input id="profilePhotoInput" placeholder="https://..."/>
    </div>

    <!-- Save Button -->
    <div>
      <button class="btn primary full" id="saveProfileBtn">Save changes</button>
    </div>
  </div>
</div>


  </main>
</div>

<!-- === SCRIPT === -->
<script type="module">
  /* ==========================
     Firebase SDK + App config
     ========================== */
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
  import {
    getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword,
    signOut, updateProfile, GoogleAuthProvider, signInWithPopup
  } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
  import {
    getFirestore, doc, setDoc, getDoc, addDoc, collection, query, getDocs,
    serverTimestamp, onSnapshot, orderBy, updateDoc
  } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

  // ---------- Fill / verify your Firebase config ----------
const firebaseConfig = {
  apiKey: "AIzaSyCzEwx-5UDnlSXbYOvUbjRmVbRz0LxUFaE",
  authDomain: "prac11-8704f.firebaseapp.com",
  projectId: "prac11-8704f",
  storageBucket: "prac11-8704f.firebasestorage.app",
  messagingSenderId: "68450755506",
  appId: "1:68450755506:web:4c1259e9ca3bc4bd6ebaab",
  measurementId: "G-5RZJL02K18"
};

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  /* ==========================
     DOM refs
     ========================== */
  const authView = document.getElementById('authView');
  const appView = document.getElementById('appView');
  const authTitle = document.getElementById('authTitle');
  const nameInput = document.getElementById('nameInput');
  const emailInput = document.getElementById('emailInput');
  const passwordInput = document.getElementById('passwordInput');
  const authSubmit = document.getElementById('authSubmit');
  const googleBtn = document.getElementById('googleBtn');
  const meName = document.getElementById('meName');
  const meEmail = document.getElementById('meEmail');
  const meAvatar = document.getElementById('meAvatar');
  const recentList = document.getElementById('recentList');
  const userSearch = document.getElementById('userSearch');
  const inviteBtn = document.getElementById('inviteBtn');
  const navLogout = document.getElementById('navLogout');




  const chatTitle = document.getElementById('chatTitle');
  const chatSub = document.getElementById('chatSub');
  const messagesEl = document.getElementById('messages');
  const composer = document.getElementById('composer');
  const emptyState = document.getElementById('emptyState');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const toggleSidebar = document.getElementById('toggleSidebar');
  const sidebar = document.getElementById('sidebar');

  /* ==========================
     State
     ========================== */
  let isSignup = true;
  let activeChatId = null;
  let messagesUnsub = null;
// === New refs for navigation + views ===
const navChats = document.getElementById('navChats');
const navPeople = document.getElementById('navPeople');
const navProfile = document.getElementById('navProfile');

const peopleView = document.getElementById('peopleView');
const profileView = document.getElementById('profileView');

const peopleListEl = document.getElementById('peopleList');

// === View switching ===
function showView(view){
  // hide all
  document.querySelector('.content').hidden = true;
  peopleView.hidden = true;
  profileView.hidden = true;

  // deactivate nav
  [navChats, navPeople, navProfile].forEach(n=>n.classList.remove('active'));

  // show chosen
  if(view === 'chats'){ document.querySelector('.content').hidden = false; navChats.classList.add('active'); }
  if(view === 'people'){ peopleView.hidden = false; navPeople.classList.add('active'); loadPeople(); }
  if(view === 'profile'){ profileView.hidden = false; navProfile.classList.add('active'); loadProfile(); }
  
}

// === Bind nav click events ===
navChats.addEventListener('click', ()=> showView('chats'));
navPeople.addEventListener('click', ()=> showView('people'));
navProfile.addEventListener('click', ()=> showView('profile'));

  /* ==========================
     Helpers
     ========================== */
  function debounce(fn, ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),ms) } }
  function escapeHtml(s){ return s?.toString().replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])) || '' }
  function timeAgo(date){
    if(!date) return '';
    const d = (typeof date === 'number') ? new Date(date) : date;
    const diff = Math.floor((Date.now() - d.getTime()) / 1000);
    if(diff < 60) return diff + "s";
    if(diff < 3600) return Math.floor(diff / 60) + "m";
    if(diff < 86400) return Math.floor(diff / 3600) + "h";
    return Math.floor(diff / 86400) + "d";
  }

  /* ==========================
     Auth UI mode switching
     ========================== */
  function setAuthMode(signup){
    isSignup = signup;
    authTitle.textContent = signup ? 'Create account' : 'Welcome back';
    authSubmit.textContent = signup ? 'Sign up' : 'Sign in';
    nameInput.parentElement.style.display = signup ? 'flex' : 'none';
    const switchEl = document.getElementById('authSwitch');
    switchEl.innerHTML = signup ? 'Already have an account? <a href="#" id="toLogin">Sign in</a>' : "Don't have an account? <a href='#' id='toSignup'>Create one</a>";
    document.getElementById('toLogin')?.addEventListener('click', e=>{ e.preventDefault(); setAuthMode(false) });
    document.getElementById('toSignup')?.addEventListener('click', e=>{ e.preventDefault(); setAuthMode(true) });
  }
  setAuthMode(true);

  /* ==========================
     Auth flows
     ========================== */
  googleBtn.addEventListener('click', async ()=>{
    try{
      const cred = await signInWithPopup(auth, provider);
      await ensureUserDoc(cred.user);
    }catch(e){
      alert(e.message || e);
      console.error(e);
    }
  });

  authSubmit.addEventListener('click', async ()=>{
    const email = emailInput.value.trim();
    const pass = passwordInput.value.trim();
    if(!email || !pass){ alert('Email and password are required'); return; }
    try{
      if(isSignup){
        const name = nameInput.value.trim() || email.split('@')[0];
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        // fix: use a string/backtick template for photoURL
        await updateProfile(cred.user, { displayName: name, photoURL: `https://api.dicebear.com/9.x/thumbs/svg?seed=${encodeURIComponent(name)}` });
        await ensureUserDoc(cred.user);
      }else{
        const cred = await signInWithEmailAndPassword(auth, email, pass);
        await ensureUserDoc(cred.user);
      }
    }catch(e){
      alert(e.message || e);
      console.error(e);
    }
  });

  navLogout.addEventListener('click', ()=> signOut(auth));
  toggleSidebar.addEventListener('click', ()=> sidebar.classList.toggle('open'));

  /* ==========================
     Auth state watcher
     ========================== */
  onAuthStateChanged(auth, async (user)=>{
    if(user){
      authView.hidden = true;
      appView.hidden = false;
      meName.textContent = user.displayName || 'Anonymous';
      meEmail.textContent = user.email || '';
      meAvatar.src = user.photoURL || `https://api.dicebear.com/9.x/thumbs/svg?seed=${encodeURIComponent(user.uid)}`;
      loadRecentChats(user.uid);
    }else{
      appView.hidden = true;
      authView.hidden = false;
      setAuthMode(false);
      // cleanup UI
      recentList.innerHTML = '';
      messagesEl.innerHTML = '';
      composer.hidden = true;
      emptyState.hidden = false;
      if(messagesUnsub){ messagesUnsub(); messagesUnsub = null; }
    }
  });

  async function ensureUserDoc(user){
    if(!user) return;
    const ref = doc(db, 'users', user.uid);
    const snap = await getDoc(ref);
    if(!snap.exists()){
      await setDoc(ref, {
        uid: user.uid,
        name: user.displayName || 'Anonymous',
        email: user.email || '',
        photoURL: user.photoURL || '',
        createdAt: serverTimestamp()
      });
    } else {
      // optional: keep profile fields updated
      const data = snap.data();
      if((data.name !== user.displayName) || (data.email !== user.email) || (data.photoURL !== user.photoURL)){
        await setDoc(ref, {
          uid: user.uid,
          name: user.displayName || data.name || 'Anonymous',
          email: user.email || data.email || '',
          photoURL: user.photoURL || data.photoURL || '',
        }, { merge: true });
      }
    }
  }

  /* ==========================
     User search
     ========================== */
  userSearch.addEventListener('input', debounce(async (e)=>{
    const term = e.target.value.trim().toLowerCase();
    const me = auth.currentUser;
    if(!me) return;
    try{
      const usersRef = collection(db, 'users');
      const qs = await getDocs(usersRef);
      const items = qs.docs.map(d=>d.data()).filter(u => u.uid !== me.uid && (!term || (u.name||'').toLowerCase().includes(term) || (u.email||'').toLowerCase().includes(term)));
      renderPeople(items);
    }catch(err){
      console.error('search error', err);
    }
  }, 300));

  function renderPeople(users){
    // Keep recentList for simplicity as the listing area (search results)
    recentList.innerHTML = "";
    users.forEach(u=>{
      const row = document.createElement('div');
      row.className = 'chat-row';
      const avatar = u.photoURL || `https://api.dicebear.com/9.x/thumbs/svg?seed=${encodeURIComponent(u.name||u.uid)}`;
      row.innerHTML = `<img src="${avatar}" alt="pfp"><div><div class='name'>${escapeHtml(u.name||'User')}</div><div class='last'>${escapeHtml(u.email||'')}</div></div><div><button class='btn'>Chat</button></div>`;
      row.querySelector('button').addEventListener('click', ()=> startChatWith(u.uid));
      recentList.appendChild(row);
    });
  }

  // invite button ‚Äî fixed: build mailto string properly and open in new window
  inviteBtn.addEventListener('click', ()=>{
    const url = location.href;
    const subject = encodeURIComponent('Join me on Chatter');
    const body = encodeURIComponent(`Let‚Äôs chat here: ${url}`);
    window.location.href = `mailto:?subject=${subject}&body=${body}`;
  });

/* ==========================
   People directory (navPeople)
   ========================== */
async function loadPeople(){
  const me = auth.currentUser;
  if(!me) return;
  const usersRef = collection(db, 'users');
  const qs = await getDocs(usersRef);
  const list = peopleListEl;
  list.innerHTML = '';
  qs.forEach(docu=>{
    const u = docu.data();
    if(u.uid === me.uid) return;
    const row = document.createElement('div');
    row.className = 'card';
    row.style.padding = '12px';
    row.style.display = 'flex';
    row.style.alignItems = 'center';
    row.style.gap = '12px';
    const avatar = u.photoURL || `https://api.dicebear.com/9.x/thumbs/svg?seed=${encodeURIComponent(u.name)}`;
    row.innerHTML = `
      <img src="${avatar}" 
           style="width:40px;height:40px;border-radius:50%">
      <div style="flex:1">
        <div style="font-weight:600">${escapeHtml(u.name||'User')}</div>
        <div class="muted">${escapeHtml(u.email||'')}</div>
      </div>
      <button class="btn">Chat</button>`;
    row.querySelector('button').addEventListener('click', ()=> startChatWith(u.uid));
    list.appendChild(row);
  });
}
function loadProfile(){
  const me = auth.currentUser;
  if(!me) return;
  document.getElementById('profileAvatar').src = me.photoURL || `https://api.dicebear.com/9.x/thumbs/svg?seed=${encodeURIComponent(me.uid)}`;
  document.getElementById('profileName').textContent = me.displayName || 'Anonymous';
  document.getElementById('profileEmail').textContent = me.email || '';
  document.getElementById('profileNameInput').value = me.displayName || '';
  document.getElementById('profilePhotoInput').value = me.photoURL || '';
}

document.getElementById('saveProfileBtn').addEventListener('click', async ()=>{
  const me = auth.currentUser;
  if(!me) return;
  const newName = document.getElementById('profileNameInput').value.trim();
  const newPhoto = document.getElementById('profilePhotoInput').value.trim();
  try{
    await updateProfile(me, { displayName: newName, photoURL: newPhoto });
    await setDoc(doc(db,'users',me.uid), { name: newName, photoURL: newPhoto }, { merge:true });
    alert('Profile updated');
    loadProfile();
  }catch(e){ alert(e.message||e); }
});


  /* ==========================
     Chats (recent list, start, open)
     ========================== */
  function loadRecentChats(uid){
    // Listen to user's mirror collection userChats/{uid}/items
    const ucRef = collection(db, 'userChats', uid, 'items');
    const qy = query(ucRef, orderBy('updatedAt','desc'));
    onSnapshot(qy, (qs)=>{
      recentList.innerHTML = '';
      qs.forEach(docu=>{
        const c = docu.data();
        // build chat row
        const row = document.createElement('div');
        row.className = 'chat-row';
        row.dataset.chatId = c.chatId;
        const avatar = c.otherPhoto || `https://api.dicebear.com/9.x/thumbs/svg?seed=${encodeURIComponent(c.otherUid)}`;
        const lastMessage = c.lastMessage || 'Say hi üëã';
        const timeText = c.updatedAt?.toDate ? timeAgo(c.updatedAt.toDate()) : '';
        row.innerHTML = `
          <img src="${avatar}" alt="pfp">
          <div><div class="name">${escapeHtml(c.otherName||'User')}</div><div class="last">${escapeHtml(lastMessage)}</div></div>
          <div class="muted">${escapeHtml(timeText)}</div>`;
        row.addEventListener('click', ()=> openChat(c.chatId, { uid: c.otherUid, name: c.otherName, photo: c.otherPhoto, email: c.otherEmail }));
        recentList.appendChild(row);
      });
    }, err => console.error('recentList onSnapshot:', err));
  }

  function composeChatId(a,b){ return a < b ? `${a}_${b}` : `${b}_${a}` }

  async function startChatWith(otherUid){
    const me = auth.currentUser;
    if(!me || me.uid === otherUid) return;
    const chatId = composeChatId(me.uid, otherUid);
    const chatRef = doc(db, 'chats', chatId);

    try{
      const chatSnap = await getDoc(chatRef);
      if(!chatSnap.exists()){
        await setDoc(chatRef, { chatId, participants:[me.uid, otherUid], createdAt: serverTimestamp(), updatedAt: serverTimestamp(), lastMessage:'' });
      }

      // Mirror entries for both users
      const otherSnap = await getDoc(doc(db,'users',otherUid));
      const meSnap = await getDoc(doc(db,'users',me.uid));

      const otherData = otherSnap.exists() ? otherSnap.data() : { name: 'User', photoURL: '' };
      const meData = meSnap.exists() ? meSnap.data() : { name: me.displayName || 'Me', photoURL: me.photoURL || '' };

      await setDoc(doc(db,'userChats',me.uid,'items',chatId), {
        chatId,
        otherUid,
        otherName: otherData.name || 'User',
        otherPhoto: otherData.photoURL || '',
        otherEmail: otherData.email || '',
        lastMessage: '',
        updatedAt: serverTimestamp()
      }, { merge: true });

      await setDoc(doc(db,'userChats',otherUid,'items',chatId), {
        chatId,
        otherUid: me.uid,
        otherName: meData.name || (me.displayName || 'Me'),
        otherPhoto: meData.photoURL || me.photoURL || '',
        otherEmail: me.email || '',
        lastMessage: '',
        updatedAt: serverTimestamp()
      }, { merge: true });

      // open chat in UI
      openChat(chatId, { uid: otherUid, name: otherData.name, photo: otherData.photoURL, email: otherData.email });
    }catch(err){
      console.error('startChatWith error', err);
      alert('Could not start chat: ' + (err.message || err));
    }
  }

  /* ==========================
     Open chat & listen messages
     ========================== */
  function openChat(chatId, other){
    activeChatId = chatId;
    chatTitle.textContent = other?.name || 'Chat';
    chatSub.textContent = other?.email || '';
    emptyState.hidden = true;
    composer.hidden = false;
    messagesEl.innerHTML = '';
    sidebar.classList.remove('open');

    if(messagesUnsub) { messagesUnsub(); messagesUnsub = null; }

    const msgsRef = collection(db, 'chats', chatId, 'messages');
    const qy = query(msgsRef, orderBy('createdAt', 'asc'));
    messagesUnsub = onSnapshot(qy, (qs)=>{
      messagesEl.innerHTML = '';
      qs.forEach(d=>{
        const m = d.data();
        const isMe = m.senderId === auth.currentUser?.uid;
        const div = document.createElement('div');
        div.className = `bubble ${isMe ? 'me' : 'you'}`;
        // preserve newlines
        const lines = (m.text || '').split('\n').map(escapeHtml).join('<br>');
        div.innerHTML = lines;
        messagesEl.appendChild(div);
      });
      // scroll to bottom
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }, err => console.error('messages onSnapshot:', err));
  }

  /* ==========================
     Send message
     ========================== */
  sendBtn.addEventListener('click', sendMessage);
  messageInput.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }
  });

  async function sendMessage(){
    const text = messageInput.value.trim();
    if(!text || !activeChatId) return;
    const me = auth.currentUser; if(!me) return;
    messageInput.value = '';
    try{
      const msgsRef = collection(db, 'chats', activeChatId, 'messages');
      await addDoc(msgsRef, { text, senderId: me.uid, createdAt: serverTimestamp() });

      // update chat last message and mirrors
      const chatRef = doc(db, 'chats', activeChatId);
      await updateDoc(chatRef, { lastMessage: text, updatedAt: serverTimestamp() });

      // determine other user id
      const [a,b] = activeChatId.split('_');
      const otherUid = (me.uid === a) ? b : a;

      await updateDoc(doc(db, 'userChats', me.uid, 'items', activeChatId), { lastMessage: text, updatedAt: serverTimestamp() });
      await updateDoc(doc(db, 'userChats', otherUid, 'items', activeChatId), { lastMessage: text, updatedAt: serverTimestamp() });
    }catch(err){
      console.error('sendMessage error', err);
      alert('Error sending message: ' + (err.message || err));
    }
  }

  /* ==========================
     Small accessibility / fallback
     ========================== */
  // If user navigates directly to app without signing in, show auth
  // onAuthStateChanged already handles that.
</script>
</body>
</html>
